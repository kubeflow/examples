<script type="text/javascript">
    RED.nodes.registerType('data process', {
        category: 'autoAI pipeline',
        color: '#4A6658',
        defaults: {
            name: {value:""},
            procedures: {value:""},
            fillna_requirement: {value:""},
            fillna: {value:""},
            fillnavalue: {value:"0"},
            datapath: {value:""},
            labelencoding_requirement: {value:""},
            labelencoding_column_name: {value:""},
            onehotencoding_requirement: {value:""},
            onehotencoding_column_name: {value:""},
            feature_scaling_requirement: {value:""},
            feature_scaling: {value:""},
            feature_range_min: {value:""},
            feature_range_max: {value:""},
            train_test_split: {value:"", required: true},
            data_reshape: {value:"", required: true},
            height: {value:""},
            width: {value:""},
            channel: {value:""},                                  
        },
        inputs:1,
        outputs:1,
        icon: "font-awesome/fa-cogs",
        label: function() {
            return this.name || "data process";
        },
        oneditprepare: function() {
            const $dataPathInput = $("#node-input-datapath");
            const $procedures = $("#node-input-procedures");
            const $fillnaRequirement = $("#node-input-fillna_requirement");
            const $fillna = $("#node-input-fillna");
            const $labelRequirement = $("#node-input-labelencoding_requirement");
            const $onehotRequirement = $("#node-input-onehotencoding_requirement");
            const $featureScalingRequirement = $("#node-input-feature_scaling_requirement");
            const $featureScaling =$("#node-input-feature_scaling")
            const $dataReshape = $("#node-input-data_reshape");
            const url = `dataprocess/${this.id}`;
            const $labelEncodingColumn = $("#node-input-labelencoding_column_name");
            const $oneHotEncodingColumn = $("#node-input-onehotencoding_column_name");

            const updateColumns = () =>{
                var path = $dataPathInput.val();
                if (!path) return;

                $.ajax({
                    url: url,
                    type: 'GET',
                    data: { path: path },
                    dataType: 'json',
                    success: (data) => {
                        const updateDropdown = ($element, savedColumns) => {
                            $element.empty();
                            data.columns.forEach(column => {
                                let displayedColumn = /^['"](.+)['"]$/.exec(column);
                                displayedColumn = displayedColumn ? displayedColumn[1] : column;
                                $element.append(new Option(displayedColumn, displayedColumn));
                            });
                            $element.select2('destroy').select2();

                            // Use previously saved columns to update dropdown values
                            if (savedColumns && Array.isArray(savedColumns)) {
                                $element.val(savedColumns).trigger('change');
                            }
                        };
                        const savedLabelEncodingColumns = this.labelencoding_column_name || [];
                        const savedOneHotEncodingColumns = this.onehotencoding_column_name || [];
                        updateDropdown($labelEncodingColumn, savedLabelEncodingColumns);
                        updateDropdown($oneHotEncodingColumn, savedOneHotEncodingColumns);
                    },
                    error: () => {
                        console.error("Error fetching columns");
                    }
                });
            
            }

            function toggleVisibility() {
                const proceduresValue = $procedures.val();
                $(".toggle-fillnarequirement,.toggle-fillna,.toggle-fillnavalue,.toggle-datapath,.toggle-labelencodingrequirement,.toggle-labelencoding,.toggle-onehotencodingrequirement,.toggle-onehotencoding,.toggle-featurescalingrequirement,.toggle-featurescaling,.toggle-traintestsplit,.toggle-datareshape,.toggle-2D,.toggle-featurerange").hide();

                switch (proceduresValue) {
                    case "fillna":
                        $(".toggle-fillnarequirement").show();
                        if ($fillnaRequirement.prop('checked')) {
                            $(".toggle-fillna").show();
                            if ($fillna.val() === "fill_na_by_value") {
                                $(".toggle-fillnavalue").show();
                            }
                        }
                        break;
                    case "encoding":
                        $(".toggle-labelencodingrequirement,.toggle-onehotencodingrequirement").show();
                        if ($labelRequirement.prop('checked') || $onehotRequirement.prop('checked')) {
                            $(".toggle-datapath").show();
                            $labelRequirement.prop('checked') && $(".toggle-labelencoding").show();
                            $onehotRequirement.prop('checked') && $(".toggle-onehotencoding").show();
                        }
                        break;
                    case "featurescaling":
                        $(".toggle-featurescalingrequirement").show();
                        if ($featureScalingRequirement.prop('checked')) {
                            $(".toggle-featurescaling").show();
                            if ($featureScaling.val() === "normalization") {
                                $(".toggle-featurerange").show();
                            }
                        }
                        break;
                    case "trantestsplit":
                        $(".toggle-traintestsplit").show();
                        break;
                    case "datareshape":
                        $(".toggle-datareshape").show();
                        if ($dataReshape.val() === "2D") {
                            $(".toggle-2D").show();
                        }
                        break;
                }
                
            }

            const handleSelect2Ordering = ($element) => {
                $element.on("select2:selecting", function(e) {
                    const $option = $(e.params.args.data.element);
                    $option.detach();
                    $element.append($option);
                    $option.prop('selected', !$option.prop('selected'));
                    e.preventDefault();
                });
            };
            

            $dataPathInput.on('blur', updateColumns);
            $procedures.add($fillnaRequirement).add($fillna).add($labelRequirement).add($onehotRequirement).add($featureScalingRequirement).add($featureScaling).add($dataReshape).on("change", toggleVisibility);

            
            if (this.procedures === 'encoding') {
                updateColumns();
            }

            handleSelect2Ordering($labelEncodingColumn.select2());
            handleSelect2Ordering($oneHotEncodingColumn.select2());
            
        },

    });
</script>

<script type="text/x-red" data-template-name="data process">
    <div class="form-row">
        <label for="node-input-name">Name</label>
        <input type="text" id="node-input-name" placeholder="Name" />
    </div>
    <div class="form-row">
        <label for="node-input-procedures">Procedures</label>
        <select id="node-input-procedures">
            <option value="fillna">FillNaN</option>
            <option value="encoding">Encoding</option>
            <option value="featurescaling">Feature Scaling</option>
            <option value="trantestsplit">Train Test Split</option>
            <option value="datareshape">Data Reshape</option>
        </select>
    </div>
    

    <!-- FillNaN Specific Fields -->
    <div class="form-row toggle-fillnarequirement">
        <label>required?</label>
        <input type="checkbox" id="node-input-fillna_requirement" style="display: inline-block; width: auto; vertical-align: top;">
    </div>
    <div class="form-row toggle-fillna">
        <label for="node-input-fillna">Fillna Methods</label>
        <select id="node-input-fillna">
            <option value="fill_na_by_value">fill_na_by_value</option>
            <option value="fill_na_by_mean">fill_na_by_mean</option>
            <option value="fill_na_by_median">fill_na_by_median</option>
        </select>
    </div>
    <div class="form-row toggle-fillnavalue">
        <label for="node-input-fillnavalue" id="fillnavalue">value</label>
        <input type="number" min="0" id="node-input-fillnavalue" />
    </div>
    

    <!-- Encoding Specific Fields -->
    <div class="form-row toggle-datapath">
        <label for="node-input-datapath" id="datapath">Data Path</label>
        <input type="text" id="node-input-datapath" placeholder="Enter the path to your data file">
    </div>
    <div class="form-row toggle-labelencodingrequirement">
        <label>label encoding</label>
        <input type="checkbox" id="node-input-labelencoding_requirement" style="display: inline-block; width: auto; vertical-align: top;">
    </div>
    <div class="form-row toggle-labelencoding">
        <label for="node-input-labelencoding_column_name" id="labelencoding_column_name">Columns</label>
        <select multiple id="node-input-labelencoding_column_name"></select>
    </div>
    <div class="form-row toggle-onehotencodingrequirement">
        <label>one hot encoding</label>
        <input type="checkbox" id="node-input-onehotencoding_requirement" style="display: inline-block; width: auto; vertical-align: top;">
    </div>
    <div class="form-row toggle-onehotencoding">
        <label for="node-input-onehotencoding_column_name" id="onehotencoding_column_name">Columns</label>
        <select multiple id="node-input-onehotencoding_column_name"></select>
    </div>
    
    
    <!-- Feature Scaling Specific Fields -->
    <div class="form-row toggle-featurescalingrequirement">
        <label>required?</label>
        <input type="checkbox" id="node-input-feature_scaling_requirement" style="display: inline-block; width: auto; vertical-align: top;">
    </div>
    <div class="form-row toggle-featurescaling">
        <label for="node-input-feature_scaling">Methods</label>
        <select id="node-input-feature_scaling">
            <option value="normalization">normalization</option>
            <option value="standardlization">standardlization</option>
        </select>
    </div>
    <div class="form-row toggle-featurerange">
        <label for="node-input-feature_range" id="feature_range">Feature Range</label>
        <input type="number" id="node-input-feature_range_min" placeholder="Min" style="width: 25%;"/>
        <input type="number" id="node-input-feature_range_max" placeholder="Max" style="width: 25%;"/>
    </div>

    <!-- Train Test Split Specific Fields -->
    <div class="form-row toggle-traintestsplit">
        <label for="node-input-train_test_split" id="train_test_split">Test Size</label>
        <input type="number" min="0.2" max="0.4" step=0.01 id="node-input-train_test_split" />
    </div>

    <!-- Data Reshape Specific Fields -->
    <div class="form-row toggle-datareshape">
        <label for="node-input-data_reshape">Reshape Size</label>
        <select id="node-input-data_reshape">
            <option value="1D">1D</option>
            <option value="2D">2D</option>
        </select>
    </div>
    <div class="form-row toggle-2D">
        <label for="node-input-height" id="height">Height</label>
        <input type="number" min="1" id="node-input-height" />
    </div>
    <div class="form-row toggle-2D">
        <label for="node-input-width" id="width">Width</label>
        <input type="number" min="1" id="node-input-width" />
    </div>
    <div class="form-row toggle-2D">
        <label for="node-input-channel" id="channel">Channel</label>
        <input type="number" min="1" max="3" id="node-input-channel" />
    </div>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js">
</script>

<script type="text/x-red" data-help-name="data process">
    <p>A node for different data processes.</p>
</script>




