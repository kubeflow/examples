<script type="text/javascript">
    RED.nodes.registerType('datasets', {
        category: 'autoAI pipeline',
        color: '#7F8C8D',
        defaults: {
            name: { value: "" },
            customized_datasets: { value: "", required: true },
            traditional_datasets: { value: "", required: true },
            label_column_name: { value: "none", required: true },
            source: { value: "traditional", required: true }
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-file-text",
        label: function() {
            return this.source === "traditional" ? this.name || this.traditional_datasets || "datasets" : this.name || this.customized_datasets.substring(this.customized_datasets.lastIndexOf('/') + 1, this.customized_datasets.length) || "datasets";
        },
        oneditprepare: function() {
            const nodeInputSource = $("#node-input-source");
            const toggleCustomized = $(".toggle-customized");
            const toggleTraditional = $(".toggle-traditional");
            const datasetsTraditional = $(".datasets-traditional");
            const datasetsCustomized = $(".datasets-customized");
            const customizedPathInput = $("#node-input-customized_datasets");
            const labelColumnName = $("#node-input-label_column_name");
            const url = `datasets/${this.id}`;
    
            const updateVisibilityAndValues = () => {
                const isTraditional = nodeInputSource.val() === "traditional";
    
                toggleCustomized.toggle(!isTraditional);
                toggleTraditional.toggle(isTraditional);
    
                datasetsTraditional.toggleClass("selected", isTraditional);
                datasetsCustomized.toggleClass("selected", !isTraditional);
    
                if (isTraditional) {
                    customizedPathInput.val("none");
                    labelColumnName.val("none");
                } else {
                    $("#node-input-traditional_datasets").val("mnist");
                    if (customizedPathInput.val() === 'none'){
                        customizedPathInput.val("")
                    }
                }
            };
    
            $(".datasets-toggle button").on("click", function() {
                nodeInputSource.val($(this).hasClass("datasets-customized") ? "customized" : "traditional");
                updateVisibilityAndValues();
            });
    
            const updateColumns = () => {
                let path = customizedPathInput .val();
    
                if (path) {
                    $.ajax({
                        url: url,
                        type: 'GET',
                        data: { path: path },
                        dataType: 'json',
                        success: (data) => {
                            labelColumnName.empty();
                            data.columns.forEach(column => {
                                // Check if the column is wrapped with quotes
                                let displayedColumn = /^['"](.+)['"]$/.exec(column);
                                displayedColumn = displayedColumn ? displayedColumn[1] : column;
            
                                let option = $('<option></option>').attr("value", column).text(displayedColumn);
                                labelColumnName.append(option);
                            });
                            // Ensure the dropdown has the current value of the node selected
                            labelColumnName.val(this.label_column_name);
                        },
                        error: () => {
                            console.error("Error fetching columns");
                        }
                    });
                }
            };
    
            customizedPathInput.on('blur', updateColumns);
            nodeInputSource.on("input", updateVisibilityAndValues);
    
            updateVisibilityAndValues();
            if (this.source === 'customized') {
                updateColumns()
            }
        }
        
    });
</script>

<script type="text/x-red" data-template-name="datasets">
    
    <div class="form-row">
        <label for="node-input-name">Name</label>
        <input type="text" id="node-input-name" placeholder="Name" />
    </div>
    <br />
    <h3>Source of Datasets </h3>
    <div class="form-row">
        <span class="datasets-toggle">
        <button
            type="button"
            class="red-ui-button toggle datasets-traditional"
        >
            Datasets
        </button>
        <button
            type="button"
            class="red-ui-button toggle datasets-customized"
        >
            Customized Datasets
        </button>
        </span>
    </div>
    <div class="form-row toggle-customized">
        <label for="node-input-customized_datasets" id="customized-datasets">Data Path</label>
        <input type="text" id="node-input-customized_datasets" placeholder="Enter the path to your data file">
    </div>
    <div class="form-row toggle-customized">
        <label for="node-input-label_column_name" id="label_column_name">Label Column</label>
        <select id="node-input-label_column_name"></select>
    </div>
    <div class="form-row toggle-traditional">  
        <label for="node-input-traditional_datasets" id="traditional-datasets">Datasets</label>
        <select id="node-input-traditional_datasets">
            <option value="mnist">mnist</option>
            <option value="cifar10">cifar-10</option>
        </select>
    </div>
    <div hidden>
        <input type="text" id="node-input-source" />
    </div>
</script>

<script type="text/x-red" data-help-name="datasets">
    <p>A node to choose datasets.</p>
</script>


