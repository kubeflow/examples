<script type="text/javascript">
    RED.nodes.registerType('model', {
        category: 'autoAI pipeline',
        color: '#008080',
        defaults: {
            name: {value:""},
            epochs: {value:"5"},
            optimizer:{value:""},
            loss:{value:""},
            validation_split:{value:""},
            model_name: {
                value:"",
                required:true,
                validate: function (x) {
                    var regex = /^model\d{2}$/;
                    return regex.test(x);
                }
            },
            overwrite:{value: false},
            model_name_isvalid: {value:"", required:true},
        },
        inputs:1,
        outputs:1,
        icon: "font-awesome/fa-plus",
        label: function() {
            return this.name || this.model_name ;
        },
        oneditprepare: function() {
            $("#node-input-name").val(this.name);
            $("#node-input-epochs").val(this.epochs);
            $("#node-input-model_name").val(this.model_name);
            $("#node-input-overwrite").prop('checked', this.overwrite);

            var url = "model/"+this.id;

            function showMessage(message, color, selector) {
                $(selector).css('color', color).text(message).show();
            }
            function validateModelName() {
                var overwriteChecked = $("#node-input-overwrite").prop('checked');
                var modelNameInput = $("#node-input-model_name");
                var modelName = modelNameInput.val();
                var filePath = `/data/1.connect-kubeflow/py/${modelName}.py`;
                var regex = /^model\d{2}$/;
                
                if (!regex.test(modelName)) {
                  modelNameInput.css('border-color', 'red');
                  $(".toggle-overwrite, #change-name-message-div, #message-div").hide();

                }else{
                  $.ajax({
                      url: url,
                      method: "POST",
                      data: { filePath: filePath },
                      success: function(response) {
                          if (response.fileExists) {
                              $(".toggle-overwrite").show();
                              showMessage('The model already exists. Do you want to overwrite it?', 'black', '#message-div');
  
                              if (!overwriteChecked) {
                                  modelNameInput.css('border-color', 'red');
                                  showMessage('change your model name', 'red', '#change-name-message-div');
                                  $("#node-input-model_name_isvalid").val("");
                                  
                              } else {
                                  modelNameInput.css('border-color', '');
                                  $('#change-name-message-div').hide();
                                  $("#node-input-model_name_isvalid").val("true");                                  

                              }
                          } else if (!response.fileExists){
                              modelNameInput.css('border-color', '');
                              $(".toggle-overwrite, #change-name-message-div, #message-div").hide();
                              $('#node-input-overwrite').prop('checked', false);
                              $("#node-input-model_name_isvalid").val("true");

                          }
                      }
                  });
              }
            }

            $("#node-input-model_name, #node-input-overwrite").on("input change", validateModelName);
        
        },
        
    });
</script>

<script type="text/x-red" data-template-name="model">
    <div class="form-row">
        <label for="node-input-name">Name</label>
        <input type="text" id="node-input-name" placeholder="Name" />
    </div>
    <div class="form-row">
        <label for="node-input-epochs" id="epochs"
          ><i class="fa"></i>Epochs
        </label>
        <input type="number" min="1" id="node-input-epochs" placeholder="5"/>
    </div>
    <div class="form-row">
        <label for="node-input-validation_split" id="validation_split"
          ><i class="fa"></i>validation_split
        </label>
        <input type="number" min="0.1" max="0.3" step="0.01" id="node-input-validation_split" placeholder="0.2"/>
    </div>
    <div class="form-row ">  
        <label for="node-input-optimizer" id="optimizer">Optimizer</label>
        <select id="node-input-optimizer">
            <option value="sgd">SGD</option>
            <option value="adam">Adam</option>
            <option value="rmsprop">RMSprop</option>
        </select>
    </div>
    <div class="form-row ">  
        <label for="node-input-loss" id="loss">Loss</label>
        <select id="node-input-loss">
            <option value="mean_squared_error">MSE</option>
            <option value="binary_crossentropy">binary_crossentropy</option>
            <option value="categorical_crossentropy">categorical_crossentropy</option>
            <option value="sparse_categorical_crossentropy">sparse_categorical_crossentropy</option> 
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-model_name">Model Name</label>
        <input type="text" id="node-input-model_name" placeholder="Enter your model name">
    </div>
    <div id="message-div" style="display: none;"></div>
    <div class="form-row toggle-overwrite" style="display: none;">
    <label>overwrite?</label>
    <input type="checkbox" id="node-input-overwrite" style="display: inline-block; width: auto; vertical-align: top;">
    </div>
    <div id="change-name-message-div" style="display: none;"></div>
    <div class="form-tips">
        <p>
          <b>Model Name:</b> The model name format should conform to 'model' followed by two digits.   ex:model01
        </p>
    </div>
    <div hidden>
        <input type="text" id="node-input-model_name_isvalid" />
    </div>
</script>

<script type="text/x-red" data-help-name="model">
    <p>A node to create model.</p>
</script>



