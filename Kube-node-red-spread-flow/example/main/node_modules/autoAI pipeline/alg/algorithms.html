<script type="text/javascript">
(function() {

function resizeDialog(size) {
    size = size || { height: $(".red-ui-tray-content form").height() }
    var rows = $("#dialog-form>div:not(.node-input-property-container-row):visible");
    var height = size.height;
    for (var i=0; i<rows.length; i++) {
        height -= $(rows[i]).outerHeight(true);
    }
    var editorRow = $("#dialog-form>div.node-input-property-container-row");
    height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
    height += 16;
    $("#node-input-property-container").editableList('height',height);
}
/** Retrieve editableList items (refactored for re-use in the form inject button)*/
function getProps(el) {
    var result = [];
    el.each(function() {
        var row = $(this);
        var dynamicInputs = row.find(".dynamic-input").map(function() {
            return $(this).val();
        }).get();

        var dynamicSelects = row.find(".dynamic-select").map(function() {
            return $(this).val();
        }).get();

        var data = {
            type: row.find('.node-input-select-box').val(),
            datainput: dynamicInputs,
            dataselect: dynamicSelects
        };
        result.push(data);
    });
    return result;
}
function Dropout(parent){
    $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
                        .text('(')
                        .appendTo(parent);
    $('<input/>', {type: "text", class: "dynamic-input"})
                .css("width", "10%")
                .appendTo(parent);
    $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
            .text('),')
            .appendTo(parent);
}
function Dense(parent){
    $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
                        .text('(')
                        .appendTo(parent);
    $('<input/>', {type: "text", class: "dynamic-input"})
                .css("width", "10%")
                .appendTo(parent);
    $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
            .text(', activation=')
            .appendTo(parent);
    var select = $('<select/>', {class: "dynamic-select"})
                .css("width", "auto")
                .appendTo(parent);

        // 添加选项到下拉菜单
        select.append($('<option/>', {value: "softmax", text: "softmax"}));
        select.append($('<option/>', {value: "sigmoid", text: "sigmoid"}));
        select.append($('<option/>', {value: "relu", text: "relu"}));
    $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
            .text('),')
            .appendTo(parent);
    
}
function Flatten(parent,i){
    $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
                        .text('(')
                        .appendTo(parent);
    if (i === 0) { // 如果是第一个元素
        $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
            .text('input_shape=(')
            .appendTo(parent);
        $('<input/>', {type: "text", class: "dynamic-input"})
            .css("width", "10%")
            .appendTo(parent);
        $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
            .text(',')
            .appendTo(parent);
        $('<input/>', {type: "text", class: "dynamic-input"})
            .css("width", "10%")
            .appendTo(parent);
        $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
            .text(',')
            .appendTo(parent);
        $('<input/>', {type: "text", class: "dynamic-input"})
            .css("width", "10%")
            .appendTo(parent);
        $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
            .text(')),')
            .appendTo(parent);
    } else { // 如果不是第一个元素
        $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
            .text('),')
            .appendTo(parent);
    }
}

    // 动态添加输入框的函数
function Conv2(parent,i) {
    $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
                    .text('(')
                    .appendTo(parent);
    $('<input/>', {type: "text", class: "dynamic-input"})
            .css("width", "10%")
            .appendTo(parent);
    $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
                    .text(', (')
                    .appendTo(parent); 
    $('<input/>', {type: "text", class: "dynamic-input"})
            .css("width", "10%")
            .appendTo(parent);
    $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
            .text(',')
            .appendTo(parent);
    $('<input/>', {type: "text", class: "dynamic-input"})
            .css("width", "10%")
            .appendTo(parent);
    $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
            .text('), padding=')
            .appendTo(parent);
    var select = $('<select/>', {class: "dynamic-select"})
        .css("width", "auto")
        .appendTo(parent);

    // 添加选项到下拉菜单
    select.append($('<option/>', {value: "same", text: "same"}));
    select.append($('<option/>', {value: "valid", text: "valid"}));
    
    $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
            .text(', activation=')
            .appendTo(parent);
    var select = $('<select/>', {class: "dynamic-select"})
        .css("width", "auto")
        .appendTo(parent);

    // 添加选项到下拉菜单
    select.append($('<option/>', {value: "relu", text: "relu"}));
    select.append($('<option/>', {value: "sigmoid", text: "sigmoid"}));
    select.append($('<option/>', {value: "softmax", text: "softmax"}));
    
// 根据索引决定显示哪种输入框
    if (i === 0) { // 如果是第一个元素
        $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
            .text(', input_shape=(')
            .appendTo(parent);
        $('<input/>', {type: "text", class: "dynamic-input"})
            .css("width", "10%")
            .appendTo(parent);
        $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
            .text(',')
            .appendTo(parent);
        $('<input/>', {type: "text", class: "dynamic-input"})
            .css("width", "10%")
            .appendTo(parent);
        $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
            .text(',')
            .appendTo(parent);
        $('<input/>', {type: "text", class: "dynamic-input"})
            .css("width", "10%")
            .appendTo(parent);
        $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
            .text(')),')
            .appendTo(parent);
    } else { // 如果不是第一个元素
        $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
            .text('),')
            .appendTo(parent);
    }
}

function MaxPooling(parent) {
    $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
                    .text('((')
                    .appendTo(parent);
    $('<input/>', {type: "text", class: "dynamic-input"})
            .css("width", "10%")
            .appendTo(parent);
    $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
                    .text(',')
                    .appendTo(parent); 
    $('<input/>', {type: "text", class: "dynamic-input"})
            .css("width", "10%")
            .appendTo(parent);
    $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
            .text(')),')
            .appendTo(parent);
}


    RED.nodes.registerType('algorithm', {
        category: 'autoAI pipeline',
        color: '#2E8B57',
        defaults: {
            name: {value:""},
            algorithm: {value:"", required:true},
            max_depth: {
                value: "20", 
                required: true,
                validate: function(x) {
                    return /^[1-9]\d*$/.test(x);
                } 
            },
            min_samples_split: { 
                value: "5", 
                required: true,
                validate: function(x) {
                    x = Number(x);
                    return x >= 2;
                }
            },
            min_samples_leaf: { 
                value: "5", 
                required: true,
                validate: function(x) {
                    x = Number(x);
                    return x >= 1;
                }
            },
            n_estimators: {
                 value: "100",
                 required: true,
                 validate: function(x) {
                    return /^(?:[1-9]\d{2,}|[1-9]\d|10)$/.test(x);
                }
            },
            criterion : {value:"gini", required:true },
            splitter: { value: "best", required: true },
            penalty : {value:"l2", required:true},
            solver : {value:"lbfgs", required:true}, 
            userInputs: { value: {} }                    
        },
        inputs:1,
        outputs:1,
        icon: "font-awesome/fa-link",
        label: function() {
            return this.name || this.algorithm || "algorithm";
        },
        oneditprepare: function() {
    
            function toggleVisibility() {
                var algorithmValue = $("#node-input-algorithm").val();
                
                $(".toggle-common,.toggle-randomforest,.toggle-decisiontree,.toggle-logisticregression,.toggle-container").hide();
            
                if (algorithmValue === "decisiontree") {
                    $(".toggle-common, .toggle-decisiontree").show();
                    $("#node-input-n_estimators").val("100")

                }else if(algorithmValue === "randomforest"){
                    $(".toggle-common, .toggle-randomforest").show();
                    
                }else if(algorithmValue === "logisticregression"){
                    $(".toggle-logisticregression").show();
                    $("#node-input-n_estimators").val("100")
                    $("#node-input-max_depth").val("20")
                    $("#node-input-min_samples_split").val("5")
                    $("#node-input-min_samples_leaf").val("5")
                    
                }else if(algorithmValue === "neuralnetwork"){
                    $(".toggle-container").show();
                    $("#node-input-n_estimators").val("100")
                    $("#node-input-max_depth").val("20")
                    $("#node-input-min_samples_split").val("5")
                    $("#node-input-min_samples_leaf").val("5")
                }
            }
            var eList = $('#node-input-property-container').css('max-height','380px').css('max-width','450px');

            eList.editableList({
                
                addItem: function(container, i, opt) {
     
                    container.css({
                        overflow: 'auto',
                        whiteSpace: 'nowrap'
                    });
                    
                    var row = $('<div/>').appendTo(container);

                    // 添加选择框
                    var selectBox = $('<select/>', {class: "node-input-select-box"})
                        .appendTo(row)
                        .css("width", "auto")
                        .on('change', function() {
                            // 清除已有的输入框
                            row.find('.dynamic-input, .dynamic-select, div').remove();

                            // 根据选择添加输入框
                            var value = $(this).val();
                            if (value === "Conv2D") {
                                Conv2(row,i); // 添加一个输入框
                            } else if (value === "MaxPooling2D") {
                                MaxPooling(row); // 添加两个输入框
                            }else if(value==="Flatten"){
                                Flatten(row,i)
                            }else if(value==="Dropout"){
                                Dropout(row)
                            }else if(value==="Dense"){
                                Dense(row)
                            }
                            // 可以根据需要继续添加其他选项的处理
                            if (opt && opt.datainput) {
                            opt.datainput.forEach(function(value, index) {
                                row.find('.dynamic-input').eq(index).val(value);
                            });
                            }
                            if (opt && opt.dataselect) {
                                opt.dataselect.forEach(function(value, index) {
                                    row.find('.dynamic-select').eq(index).val(value);
                                });
                            }
                            });

                    // 填充选择框的选项
                    selectBox.append($('<option/>', {value: "", text: "options..", disabled: 'disabled', hidden: "hidden"}));
                    selectBox.append($('<option/>', {value: "Conv2D", text:"Conv2D"}));
                    selectBox.append($('<option/>', {value: "MaxPooling2D", text: "MaxPooling2D"}));
                    selectBox.append($('<option/>', {value: "Flatten", text: "Flatten"}));
                    selectBox.append($('<option/>', {value: "Dropout", text: "Dropout"}));
                    selectBox.append($('<option/>', {value: "Dense", text: "Dense"}));
                    if (opt) {
                        // 设置选择框的值并触发change事件
                        selectBox.val(opt.type).change();
                    }

                },

            removable: true,
            });
            var userInputs = this.userInputs;
            if (userInputs && userInputs.length > 0) {
            userInputs.forEach(function(input) {
                eList.editableList('addItem', input);
            });
            }

            toggleVisibility()

            $("#node-input-algorithm").on("change", toggleVisibility);
        },
        oneditsave: function() {
            this.userInputs = getProps($('#node-input-property-container').editableList('items')); 
        },
        oneditresize: resizeDialog
    })
})();
</script>

<script type="text/x-red" data-template-name="algorithm">
    <div class="form-row">
        <label for="node-input-name">Name</label>
        <input type="text" id="node-input-name" placeholder="Name" />
    </div>
    <div class="form-row">
        <label for="node-input-algorithm">Algorithm</label>
        <select id="node-input-algorithm">
            <option value="decisiontree">Decision Tree</option>
            <option value="randomforest">Random Forest</option>
            <option value="logisticregression">Logistic Regression</option>
            <option value="neuralnetwork">Neural Network</option>
        </select>
    </div>
    
    <div class="form-row node-input-property-container-row toggle-container">
        <ol id="node-input-property-container"></ol>
    </div>

    <!-- Random Forest Specific Fields -->
    <div class="form-row toggle-randomforest">
        <label for="node-input-n_estimators"><i class="fa"></i>n_estimators</label>
        <input type="number" min="10" id="node-input-n_estimators" />
    </div>

    <!-- RF&DT Common Fields -->
    <div class="form-row toggle-common">
        <label for="node-input-max_depth" id="max_depth"
          ><i class="fa"></i>Max Depth
        </label>
        <input type="number" min="1" id="node-input-max_depth" />
        <br>
        <label for="node-input-min_samples_split" id="min_samples_split"
        ><i class="fa"></i>min_samples_split
        </label>
        <input type="number" min="2" step="0.1" id="node-input-min_samples_split" style="width: 306px; margin-left: 23px;" />
        <br>
        <label for="node-input-min_samples_leaf" id="min_samples_leaf"
          ><i class="fa"></i>min_samples_leaf
        </label>
        <input type="number" min="1" step="0.1" id="node-input-min_samples_leaf" style="width: 309px; margin-left: 20px;" />
        <br><br>
        <label for="node-input-criterion">Criterion</label>
        <select id="node-input-criterion">
            <option value="gini">gini</option>
            <option value="entropy">entropy</option>
            <option value="log_loss">log_loss</option>
        </select>
    </div>
    
    <!-- Decision Tree Specific Fields -->
    <div class="form-row toggle-decisiontree">
        <label for="node-input-splitter">Splitter</label>
        <select id="node-input-splitter">
            <option value="random">random</option>
            <option value="best">best</option>
        </select>
    </div>
    <div class="form-tips toggle-decisiontree">
        <p>
          For more details about parameter using in the classifier, see <a href="https://scikit-learn.org/stable/modules/generated/sklearn.tree.DecisionTreeClassifier.html" target="_blank" rel="noopener noreferrer">this documentation</a>.
        </p>
    </div> 
    
    <!-- Random Forest Specific Fields -->
    <div class="form-tips toggle-randomforest">
        <p>
            For more details about parameter using in the classifier, see <a href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestClassifier.html#sklearn.ensemble.RandomForestClassifier" target="_blank" rel="noopener noreferrer">this documentation</a>.
        </p>
    </div>

    <!-- Logistic Regression Specific Fields -->
    <div class="form-row toggle-logisticregression">  
        <label for="node-input-penalty">Penalty</label>
        <select id="node-input-penalty">
            <option value="l1">l1</option>
            <option value="l2">l2</option>
            <option value="elasticnet">elasticnet</option>
            <option value="None">None</option>
        </select>
    </div>
    <div class="form-row toggle-logisticregression">  
        <label for="node-input-solver">Solver</label>
        <select id="node-input-solver">
            <option value="lbfgs">lbfgs</option>
            <option value="liblinear">liblinear</option>
            <option value="newton-cg">newton-cg</option>
            <option value="newton-cholesky">newton-cholesky</option>
            <option value="sag">sag</option>
            <option value="saga">saga</option>
        </select>
    </div>
    <div class="form-tips toggle-logisticregression">
        <p>
            For more details about parameter using in the classifier see <a href="https://scikit-learn.org/stable/modules/generated/sklearn.linear_model.LogisticRegression.html#sklearn.linear_model.LogisticRegression" target="_blank" rel="noopener noreferrer">this documentation</a>.
        </p>
    </div>
</script>

<script type="text/x-red" data-help-name="algorithm">
    <p>A node for different algorithms.</p>
</script>




